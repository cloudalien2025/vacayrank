{
  "kb_version": "1.0.0",
  "rules": [
    {
      "id": "CLOUDFLARE_BLOCK_DETECT",
      "title": "Detect Cloudflare block",
      "trigger": "api_evidence",
      "conditions": ["status_code == 403", "response_text_snippet contains Cloudflare or Attention Required"],
      "classification": {"error_type": "CLOUDFLARE_BLOCK"},
      "severity": "blocker",
      "recommended_actions": ["Verify Cloudflare custom rules", "Exclude /api/ routes from browser-only checks"],
      "playbook_ref": "PLAYBOOK_FIX_CLOUDFLARE_API_BLOCK",
      "status": "active",
      "confidence": 0.99,
      "last_verified": "2026-02-20",
      "provenance": {"source": "Observed production evidence", "confidence": 0.99, "last_verified": "2026-02-20"}
    },
    {
      "id": "NON_HUMAN_BROWSER_RULE_BLOCK",
      "title": "Detect Non-Human Browser rule blocks",
      "trigger": "api_evidence",
      "conditions": ["status_code == 403", "UA or snippet indicates python/curl/wget/headless or rule mentions Non-Human Browsers"],
      "classification": {"error_type": "CLOUDFLARE_NON_HUMAN_UA_BLOCK"},
      "severity": "warn",
      "recommended_actions": ["Adjust rule expression for API paths", "Keep browser checks on HTML routes only"],
      "playbook_ref": "PLAYBOOK_FIX_CLOUDFLARE_API_BLOCK",
      "status": "active",
      "confidence": 0.95,
      "last_verified": "2026-02-20",
      "provenance": {"source": "Cloudflare diagnostics", "confidence": 0.95, "last_verified": "2026-02-20"}
    },
    {
      "id": "AUTH_FORBIDDEN_DETECT",
      "title": "Detect auth forbidden without Cloudflare signature",
      "trigger": "api_evidence",
      "conditions": ["status_code in [401,403]", "no Cloudflare signature"],
      "classification": {"error_type": "AUTH_FORBIDDEN"},
      "severity": "blocker",
      "recommended_actions": ["Validate X-Api-Key", "Confirm API key permissions and source IP allowlists"],
      "playbook_ref": "PLAYBOOK_FIX_AUTH_FORBIDDEN",
      "status": "active",
      "confidence": 0.96,
      "last_verified": "2026-02-20",
      "provenance": {"source": "Observed API failures", "confidence": 0.96, "last_verified": "2026-02-20"}
    },
    {
      "id": "BD_WRAPPER_JSON_DETECT",
      "title": "Detect BD wrapper JSON",
      "trigger": "api_evidence",
      "conditions": ["response_json_type == dict", "bd_status present", "records parsed from wrapper list"],
      "classification": {"signal_type": "BD_WRAPPER_JSON"},
      "severity": "info",
      "recommended_actions": ["Keep wrapper normalization path enabled", "Record bd_status in evidence"],
      "playbook_ref": "PLAYBOOK_FIX_BD_WRAPPER_PARSING",
      "status": "active",
      "confidence": 0.97,
      "last_verified": "2026-02-20",
      "provenance": {"source": "Observed API payload shape", "confidence": 0.97, "last_verified": "2026-02-20"}
    },
    {
      "id": "BD_HTML_RESPONSE_DETECT",
      "title": "Detect HTML response from API endpoint",
      "trigger": "html_fetch",
      "conditions": ["status_code == 200", "response_content_type contains text/html"],
      "classification": {"error_type": "BD_HTML_RESPONSE"},
      "severity": "warn",
      "recommended_actions": ["Ensure output_type=array", "Verify endpoint and HTTP method"],
      "playbook_ref": "PLAYBOOK_FIX_BD_WRAPPER_PARSING",
      "status": "active",
      "confidence": 0.93,
      "last_verified": "2026-02-20",
      "provenance": {"source": "Historical parse failures", "confidence": 0.93, "last_verified": "2026-02-20"}
    },
    {
      "id": "BASE_URL_REDIRECT_RISK",
      "title": "Detect base URL redirect risk",
      "trigger": "crawl_snapshot",
      "conditions": ["base_url != resolved_base_url"],
      "classification": {"risk_type": "BASE_URL_REDIRECT"},
      "severity": "warn",
      "recommended_actions": ["Persist canonical base URL", "Re-run API call with resolved base URL"],
      "playbook_ref": "PLAYBOOK_FIX_BASE_URL_REDIRECT",
      "status": "active",
      "confidence": 0.9,
      "last_verified": "2026-02-20",
      "provenance": {"source": "Operational incidents", "confidence": 0.9, "last_verified": "2026-02-20"}
    },
    {
      "id": "SILENT_EMPTY_GUARD",
      "title": "Guard against silent empty results",
      "trigger": "api_evidence",
      "conditions": ["records_parsed == 0", "parse_errors is empty"],
      "classification": {"risk_type": "SILENT_EMPTY"},
      "severity": "warn",
      "recommended_actions": ["Annotate evidence with explicit warning", "Verify wrapper keys and endpoint response"],
      "playbook_ref": "PLAYBOOK_FIX_BD_WRAPPER_PARSING",
      "status": "active",
      "confidence": 0.98,
      "last_verified": "2026-02-20",
      "provenance": {"source": "Evidence-first doctrine", "confidence": 0.98, "last_verified": "2026-02-20"}
    },
    {
      "id": "URLENCODED_FIELDS_PRESENT",
      "title": "Detect URL-encoded fields",
      "trigger": "api_evidence",
      "conditions": ["response snippets include %3A or %2F"],
      "classification": {"risk_type": "DISPLAY_DECODE_NEEDED"},
      "severity": "info",
      "recommended_actions": ["Decode encoded values for display and CSV export"],
      "playbook_ref": "PLAYBOOK_FIX_BD_WRAPPER_PARSING",
      "status": "active",
      "confidence": 0.88,
      "last_verified": "2026-02-20",
      "provenance": {"source": "Observed encoded field values", "confidence": 0.88, "last_verified": "2026-02-20"}
    }
  ]
}
